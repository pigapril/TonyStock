import React, { useState, useCallback, useRef, useEffect } from 'react';
import { FaSearch } from 'react-icons/fa';
import debounce from 'lodash/debounce';
import { getErrorMessage } from '../../utils/errorHandler';
import './styles/GoogleTrendsSearchBox.css';

export const GoogleTrendsSearchBox = ({ onSelect, googleTrendsService }) => {
    const searchRef = useRef(null);
    const [searchState, setSearchState] = useState({
        keyword: '',
        results: [],
        loading: false,
        error: null,
        showResults: false
    });

    useEffect(() => {
        function handleClickOutside(event) {
            if (searchRef.current && !searchRef.current.contains(event.target)) {
                setSearchState(prev => ({
                    ...prev,
                    showResults: false
                }));
            }
        }

        document.addEventListener('mousedown', handleClickOutside);
        return () => {
            document.removeEventListener('mousedown', handleClickOutside);
        };
    }, []);

    const searchStocks = useCallback(async (value) => {
        if (!value.trim()) {
            setSearchState(prev => ({
                ...prev,
                results: [],
                loading: false
            }));
            return;
        }

        setSearchState(prev => ({
            ...prev,
            loading: true,
            error: null
        }));

        try {
            // ‰øÆÊîπÈÄôË£°ÔºåË™øÁî® googleTrendsService ÁöÑÊêúÂ∞ã API
            const data = await googleTrendsService.searchStocks(value); // ÂÅáË®≠ googleTrendsService Êúâ searchStocks ÊñπÊ≥ï
            setSearchState(prev => ({
                ...prev,
                results: data.results, // ÂÅáË®≠ËøîÂõûÁµêÊûúÁµêÊßãÁõ∏Âêå
                loading: false
            }));
        } catch (error) {
            setSearchState(prev => ({
                ...prev,
                error: getErrorMessage(error),
                loading: false
            }));
        }
    }, [googleTrendsService]);

    const debouncedSearch = useCallback(
        debounce(value => searchStocks(value), 300),
        [searchStocks]
    );

    const handleSearchInput = useCallback((event) => {
        const value = event.target.value;
        setSearchState(prev => ({
            ...prev,
            keyword: value,
            showResults: !!value.trim(), // ÊúâËº∏ÂÖ•ÊôÇÊâçÈ°ØÁ§∫ÁµêÊûú
            error: null // Ê∏ÖÈô§ÈåØË™§Ë®äÊÅØ
        }));
        debouncedSearch(value);
    }, [debouncedSearch]);


    const handleSelect = useCallback((stock) => {
        if (!stock || !stock.symbol) {
            console.error('Invalid stock data:', stock);
            return;
        }
        onSelect(stock);
        setSearchState(prev => ({
            ...prev,
            keyword: '',
            results: [],
            showResults: false
        }));
    }, [onSelect]);

    return (
        <div className="googletrends-search-area" ref={searchRef}>
            <div className="search-container">
                <span className="search-icon">
                    <FaSearch />
                </span>
                <input
                    type="text"
                    value={searchState.keyword}
                    onChange={handleSearchInput}
                    placeholder="Ëº∏ÂÖ•ËÇ°Á•®‰ª£Ëôü"
                    className="search-input"
                />
            </div>
            {searchState.showResults && (
                <div className="search-results-container">
                    {searchState.loading ? (
                        <div className="search-loading">
                            <div className="spinner" />
                            <span>ÊêúÂ∞ã‰∏≠...</span>
                        </div>
                    ) : searchState.error ? (
                        <div className="search-empty-state">
                            <span className="icon">‚ö†Ô∏è</span>
                            <span className="message">{searchState.error}</span>
                        </div>
                    ) : searchState.results.length === 0 && searchState.keyword.trim() ? (
                        <div className="search-empty-state">
                            <span className="icon">üîç</span>
                            <span className="message">Êâæ‰∏çÂà∞Á¨¶ÂêàÁöÑËÇ°Á•®</span>
                        </div>
                    ) : searchState.results.length > 0 ? (
                        <div className="search-results">
                            {searchState.results.map((stock) => (
                                <div
                                    key={stock.symbol}
                                    className="stock-result-item"
                                    onClick={() => handleSelect(stock)}
                                >
                                    <span className="stock-symbol">{stock.symbol}</span>
                                    <span className="stock-name">{stock.name}</span>
                                    <span className="stock-market">{stock.market}</span>
                                </div>
                            ))}
                        </div>
                    ) : null}
                </div>
            )}
        </div>
    );
}; 