# çœŸå¯¦ç”¨é‡è¿½è¹¤å¯¦ç¾

## ğŸ¯ **å•é¡Œåˆ†æ**

ç”¨æˆ¶è©¢å• user account é é¢çš„ç”¨é‡è¿½è¹¤æ•¸æ“šæ˜¯å¦ç‚ºçœŸå¯¦æ•¸æ“šã€‚ç¶“éåˆ†æç™¼ç¾ï¼š

### **åŸæœ¬çš„ç‹€æ³ï¼ˆMock è³‡æ–™ï¼‰**
- âŒ Frontend å®Œå…¨ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„ mock è³‡æ–™
- âŒ æ²’æœ‰å°æ‡‰çš„å¾Œç«¯ API ç«¯é»
- âŒ é›–ç„¶å¾Œç«¯æœ‰å®Œæ•´çš„ç”¨é‡è¿½è¹¤åŸºç¤è¨­æ–½ï¼Œä½†å‰ç«¯ç„¡æ³•å­˜å–

### **ç‚ºä»€éº¼ä½¿ç”¨ Mock è³‡æ–™ï¼Ÿ**
1. **é–‹ç™¼éšæ®µçš„æ¬Šå®œä¹‹è¨ˆ**ï¼šé¿å…å›  API ä¸å­˜åœ¨è€Œç”¢ç”ŸéŒ¯èª¤
2. **å‰å¾Œç«¯é–‹ç™¼é€²åº¦ä¸åŒæ­¥**ï¼šè®“å‰ç«¯é–‹ç™¼å¯ä»¥ç¹¼çºŒé€²è¡Œ
3. **è¨»è§£ä¸­æ˜ç¢ºæ¨™ç¤º**ï¼š`// Mock è³‡æ–™ - é–‹ç™¼éšæ®µä½¿ç”¨`

## âœ… **è§£æ±ºæ–¹æ¡ˆå¯¦ç¾**

### **1. å¾Œç«¯ API ç«¯é»å¯¦ç¾**

#### **æ–°å¢ Controller æ–¹æ³•**
- **æ–‡ä»¶**ï¼š`backend/src/modules/auth/controllers/auth.controller.js`
- **æ–¹æ³•**ï¼š`getUserUsageStats()`
- **åŠŸèƒ½**ï¼š
  - å¾ Redis ç²å–çœŸå¯¦çš„ç”¨é‡æ•¸æ“š
  - çµåˆæ–¹æ¡ˆé™åˆ¶é…ç½®
  - è¨ˆç®—é‡ç½®æ™‚é–“
  - è¿”å›æ¨™æº–åŒ–çš„ç”¨é‡çµ±è¨ˆæ ¼å¼

#### **æ–°å¢è·¯ç”±**
- **æ–‡ä»¶**ï¼š`backend/src/modules/auth/routes/auth.routes.js`
- **ç«¯é»**ï¼š`GET /api/auth/usage-stats`
- **ä¸­é–“ä»¶**ï¼šèªè­‰ + ç”¨æˆ¶è³‡æ–™è¼‰å…¥
- **å›æ‡‰æ ¼å¼**ï¼š
```json
{
  "status": "success",
  "data": {
    "daily": {
      "lohasSpectrum": { "used": 2, "limit": 5, "resetTime": "2025-01-26T00:00:00.000Z" },
      "marketSentiment": { "used": 1, "limit": 2, "resetTime": "2025-01-26T00:00:00.000Z" },
      "watchlist": { "used": 0, "limit": 0, "resetTime": "2025-01-26T00:00:00.000Z" }
    },
    "monthly": {
      "lohasSpectrum": { "used": 15, "limit": 5, "resetTime": "2025-02-01T00:00:00.000Z" },
      "marketSentiment": { "used": 8, "limit": 2, "resetTime": "2025-02-01T00:00:00.000Z" },
      "watchlist": { "used": 0, "limit": 0, "resetTime": "2025-02-01T00:00:00.000Z" }
    }
  }
}
```

### **2. å‰ç«¯æœå‹™æ›´æ–°**

#### **ä¿®æ”¹ subscriptionService.js**
- **ç§»é™¤**ï¼šç¡¬ç·¨ç¢¼çš„ mock è³‡æ–™
- **æ–°å¢**ï¼šçœŸå¯¦çš„ API å‘¼å«
- **ä¿ç•™**ï¼šéŒ¯èª¤è™•ç†çš„ fallback æ©Ÿåˆ¶
- **æ”¹é€²**ï¼šæ›´å¥½çš„éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„

#### **API æ•´åˆ**
```javascript
async getUserUsageStats() {
  try {
    // ä½¿ç”¨çœŸå¯¦çš„ API ç²å–ç”¨é‡çµ±è¨ˆ
    const response = await apiClient.get('/api/auth/usage-stats');
    
    if (response.data.status === 'success') {
      return response.data.data;
    } else {
      throw new Error(response.data.message || 'Failed to get usage stats');
    }
  } catch (error) {
    // Fallback åˆ°é è¨­å€¼ï¼Œç¢ºä¿ UI ä¸æœƒå´©æ½°
    return defaultUsageStats;
  }
}
```

### **3. è³‡æ–™æµç¨‹**

#### **çœŸå¯¦ç”¨é‡è¿½è¹¤æµç¨‹**
1. **API å‘¼å«è¿½è¹¤**ï¼š`trackApiUsage.middleware.js` è¨˜éŒ„æ¯æ¬¡ API ä½¿ç”¨
2. **Redis å„²å­˜**ï¼š`usageTracking.service.js` å°‡ç”¨é‡æ•¸æ“šå­˜å…¥ Redis
3. **æ•¸æ“šç²å–**ï¼šæ–°çš„ API ç«¯é»å¾ Redis è®€å–çœŸå¯¦ç”¨é‡
4. **å‰ç«¯é¡¯ç¤º**ï¼šSubscriptionContext ç²å–ä¸¦é¡¯ç¤ºçœŸå¯¦æ•¸æ“š

#### **è³‡æ–™çµæ§‹å°æ‡‰**
- **Redis Key æ ¼å¼**ï¼š`usage:${userId}:${endpoint}:${date}`
- **ç«¯é»å°æ‡‰**ï¼š
  - `/api/stock/analysis` â†’ `lohasSpectrum`
  - `/api/market-sentiment` â†’ `marketSentiment`
  - `/api/watchlist` â†’ `watchlist`

## ğŸ§ª **æ¸¬è©¦é©—è­‰**

### **æ¸¬è©¦è…³æœ¬**
- **æ–‡ä»¶**ï¼š`backend/src/scripts/test-usage-stats-api.js`
- **åŠŸèƒ½**ï¼š
  - ç›´æ¥æ¸¬è©¦ usageTracking.service
  - æ¸¬è©¦æ–°çš„ API ç«¯é»
  - é©—è­‰æ•¸æ“šæ ¼å¼å’Œå®Œæ•´æ€§
  - è‡ªå‹•æ¸…ç†æ¸¬è©¦æ•¸æ“š

### **æ¸¬è©¦æ­¥é©Ÿ**
```bash
# é‹è¡Œæ¸¬è©¦è…³æœ¬
node backend/src/scripts/test-usage-stats-api.js

# åªæ¸¬è©¦ API ç«¯é»
node backend/src/scripts/test-usage-stats-api.js --api-only

# åªæ¸¬è©¦æœå‹™å±¤
node backend/src/scripts/test-usage-stats-api.js --service-only
```

## ğŸ”„ **å‘å¾Œå…¼å®¹æ€§**

### **æ¼¸é€²å¼å‡ç´š**
1. **ä¿ç•™ Fallback**ï¼šå¦‚æœ API å¤±æ•—ï¼Œä»æœƒè¿”å›é è¨­å€¼
2. **éŒ¯èª¤è™•ç†**ï¼šä¸æœƒå› ç‚º API éŒ¯èª¤è€Œå°è‡´é é¢å´©æ½°
3. **é–‹ç™¼æ¨¡å¼**ï¼šåœ¨é–‹ç™¼ç’°å¢ƒä¸­æä¾›é¡å¤–çš„æ—¥èªŒå’Œè­¦å‘Š

### **éƒ¨ç½²ç­–ç•¥**
1. **å¾Œç«¯å…ˆéƒ¨ç½²**ï¼šç¢ºä¿ API ç«¯é»å¯ç”¨
2. **å‰ç«¯å¾Œéƒ¨ç½²**ï¼šåˆ‡æ›åˆ°çœŸå¯¦ API å‘¼å«
3. **ç›£æ§é©—è­‰**ï¼šç¢ºèªæ•¸æ“šæ­£ç¢ºæ€§å’Œæ€§èƒ½

## ğŸ“Š **é æœŸæ•ˆæœ**

### **ç”¨æˆ¶é«”é©—æ”¹å–„**
- âœ… **çœŸå¯¦æ•¸æ“š**ï¼šé¡¯ç¤ºå¯¦éš›çš„ API ä½¿ç”¨æƒ…æ³
- âœ… **å³æ™‚æ›´æ–°**ï¼šæ¯ 5 åˆ†é˜è‡ªå‹•åˆ·æ–°ç”¨é‡çµ±è¨ˆ
- âœ… **æº–ç¢ºé™åˆ¶**ï¼šåŸºæ–¼çœŸå¯¦ç”¨é‡çš„é…é¡ç®¡ç†

### **é–‹ç™¼é«”é©—æ”¹å–„**
- âœ… **æ•¸æ“šä¸€è‡´æ€§**ï¼šå‰å¾Œç«¯æ•¸æ“šåŒæ­¥
- âœ… **é™¤éŒ¯èƒ½åŠ›**ï¼šå¯ä»¥è¿½è¹¤å¯¦éš›çš„ API ä½¿ç”¨æ¨¡å¼
- âœ… **ç›£æ§èƒ½åŠ›**ï¼šäº†è§£ç”¨æˆ¶çš„å¯¦éš›ä½¿ç”¨è¡Œç‚º

## ğŸš€ **å¾ŒçºŒå„ªåŒ–**

### **çŸ­æœŸæ”¹é€²**
1. **å¿«å–å„ªåŒ–**ï¼šæ·»åŠ é©ç•¶çš„å¿«å–æ©Ÿåˆ¶
2. **æ€§èƒ½ç›£æ§**ï¼šç›£æ§ API å›æ‡‰æ™‚é–“
3. **éŒ¯èª¤è¿½è¹¤**ï¼šæ”¹å–„éŒ¯èª¤æ—¥èªŒå’Œè¿½è¹¤

### **é•·æœŸè¦åŠƒ**
1. **æ­·å²æ•¸æ“š**ï¼šæä¾›ç”¨é‡æ­·å²è¶¨å‹¢
2. **é æ¸¬åˆ†æ**ï¼šåŸºæ–¼ä½¿ç”¨æ¨¡å¼çš„é…é¡é è­¦
3. **å€‹äººåŒ–å»ºè­°**ï¼šæ ¹æ“šç”¨é‡æ¨¡å¼æ¨è–¦é©åˆçš„æ–¹æ¡ˆ

## ğŸ”§ **æŠ€è¡“ç´°ç¯€**

### **ä¾è³´é—œä¿‚**
- `usageTracking.service.js`ï¼šRedis ç”¨é‡è¿½è¹¤æœå‹™
- `plans.config.js`ï¼šæ–¹æ¡ˆé™åˆ¶é…ç½®
- `trackApiUsage.middleware.js`ï¼šAPI ä½¿ç”¨è¿½è¹¤ä¸­é–“ä»¶

### **é…ç½®è¦æ±‚**
- Redis é€£æ¥æ­£å¸¸é‹ä½œ
- ç”¨æˆ¶èªè­‰ä¸­é–“ä»¶æ­£ç¢ºé…ç½®
- æ–¹æ¡ˆé…ç½®æª”æ¡ˆå®Œæ•´

### **ç›£æ§æŒ‡æ¨™**
- API å›æ‡‰æ™‚é–“
- Redis æŸ¥è©¢æ€§èƒ½
- éŒ¯èª¤ç‡å’Œé¡å‹
- ç”¨é‡æ•¸æ“šæº–ç¢ºæ€§